
fork by https://github.com/tangr1

[概述](#概述)

[聊天功能](#聊天功能)

[接入](#接入)

[部署](#部署)

[价格](#价格)

[安全](#安全)

[数据统计](#数据统计)

[总结](#总结)

[个人选型意见](#个人选型意见)

[附录一 用户接入细节](#附录一用户接入细节)

---

### <span id="overview">概述</span>

目前IM云方案分专业玩家和巨头玩家两种：

**专业玩家**

* [环信](http://www.easemob.com/)
* [融云](http://www.rongcloud.cn/)
* [亲加通讯云](http://www.gotye.com.cn/)
* [容联云通讯](http://www.yuntongxun.com/)

**巨头玩家** (BAT中百度开放云暂未提供IM服务)

* [阿里悟空](https://imwukong.com/)
* [腾讯云通信](https://www.qcloud.com/product/im.html)
* [网易云信](netease.im)

下面是典型的IM云架构（以网易云信为例）：

![Alt text](http://dev.netease.im/images/upload/nim_func.png)

在应用服务器端，会调用IM云的一些管理接口；而主要的集成是在应用客户端，使用IM云提供的SDK实现聊天功能，通过和云服务器维持长连接来进行消息传递；大部分IM云的SDK还提供了UI库帮助应用实现各种聊天组件

一个理想的IM云应该具备以下特点：

* 满足当前业务功能
* 持续服务有保障，短期不会停止服务
* 可用性有保障，不会频繁宕机或宕机时间过长
* 并发性好，同时在线用户量和单群容量大
* 节点分布广，网络时延低，解决移动环境弱网络丢消息问题
* 接入方案简单，且支持常见的各类客户端
* 价格合理，最好有免费空间便于前期零成本试错
* 部署方案灵活
* 功能全面，可以未来业务拓展
* 安全有保障
* 具有不错的监控和数据统计分析功能
* 7*24客服

根据上述特点，下面重点从几个方面来比较这些方案：

### <span id="chat">聊天功能</span>

| | 环信 | 融云 | 亲加 | 容联 | 阿里 | 腾讯 | 网易 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 单聊 | √ | √ | √ | √ | √ | √ | √ |
| 讨论组 | | √ | √ | √ |  | √ | |
| 群组 | 2000 | 3000 | 2000 | 2000 | 1500 | 10000 | 200可扩展 |
| 聊天室 | 5000 | 无上限 | √ | √ | | 10000 | 无上限 |
| 直播聊天室 | | 无上限 | √ | √ | | 无上限 | 无上限 |
| 表情消息 | √ | √ | √ | √ | √ | √ | √ |
| 图片消息 | √ | √ | √ | √ | √ | √ | √ |
| 语音消息 |  | √ | √ | √ | √ | √ | √ |
| 小视频消息| √ | | √ | | | | √ |
| 地理位置消息 | √ | √ | √ | √ | √ | √ | √ |
| 附件 | √ | √ | | √ | √ | √ | √ |
| 白板 | | | | | | | √ |
| 自定义消息 | √ | √ | √ | | √ | √ | √ |
| 公众号 | | √ | | | | | |
| 客服号 | √ | √ | √ | | | | |
| 消息多端同步 | | √ | | √ | | √ | √ |
| 消息回执 | √ | √ | √ | √ | | √ | √ |
| 音频通话 | √ | √ | √ | √ | | √ | √ |
| 视频通话 | √ | √ | √ | √ | | √ | √ |

* 讨论组：指两个以上用户一起进行聊天，用户可以自行添加好友生成一个讨论组聊天，会话关系由融云负责建立并保持，退出聊天界面或者离线后可以收到推送通知
* 群组：指两个以上用户一起进行聊天，与讨论组不同的是，参与群组聊天的群成员由客户提供并维系，IM云只负责将消息传达给群聊中的所有用户，退出聊天界面或者离线后可以收到推送通知
* 聊天室：用户退出聊天界面即视为离开聊天室，不再会接收到任何通知和提醒
* 直播聊天室：人数上限较高，并发即时到达的消息数量级非常高，且需要实现直播中献花、打赏、点赞、红包等特殊场景功能

**结论**：融云和网易的功能最全，环信、亲家、容联、腾讯为第二梯队，阿里的功能最少

### <span id="integrate">接入</span>

#### 概况

| | 环信 | 融云 | 亲加 | 容联 | 阿里 | 腾讯 | 网易 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 安卓 | √ | √ | √ | √ | √ | √ | √ |
| 苹果 | √ | √ | √ | √ | √ | √ | √ |
| Windows PC | | √ | √ | √ | | √ | √ |
| 网页 | √ | √ | √ | √ | √ | √ | √ |
| 服务端 | √ | √ | √ | √ | √ | √ | √ |
| 嵌入式Linux (ARM, MIPS) | √ | | | | | | |
| 是否有Demo应用及源码 | √ | √ | | √ | | √ | √ |
| 是否有视频教程 | √ | √ | | | | | √ |
| 是否提供UI组件 | √ | √ | | | | | |
| 支持不同步用户 | | √ | | √ | √ | √ | √ |

* 支持不同步用户：指对于未接入IM云之前应用已注册的用户，不需要手动将其导入到IM中去

**结论**：融云和网易第一梯队，腾讯、容联、环信第二梯队，亲加和阿里最后

#### 具体过程

一个典型的接入过程是：

1. 注册成为开发者并登录管理后台创建应用
2. 应用整合SDK
3. 根据IM云提供的不同方式，应用的用户通过SDK的API登录和连接IM云服务器，同时可能需要与应用服务器通信获取信息
4. 通过SDK的API进行聊天和其他功能
5. 如果SDK提供了UI组件，也可以直接利用
6. 在IM的管理后台进行监控和数据分析

在附录中详细介绍了每种IM云的[用户接入细节](#附录一用户接入细节)，这部分是整个接入过程中最重要的部分

### <span id="deploy">部署</span>

| | 环信 | 融云 | 亲加 | 容联 | 阿里 | 腾讯 | 网易 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 公有云 | √ | √ | √ | √ | √ | √ | √ |
| 专有云 | √ | √ | | √ | | | |
| 私有云 | | √ | | √ | | | √ |
| 海外结点 | | √ | √ | | | | √ |
| SLA | 99.9% | | 99.99% | 99.999% | | 99.99% | |

鉴于目前IM云现状，各家宣称的SLA仅供参考

**结论**： 融云第一，网易、容联次之，环信、亲加再次之，腾讯、阿里最后

### <span id="price">价格</span>

#### 环信

1. [价格详情](http://www.easemob.com/pricing/im)
1. 免费条件：日活30万以下免费
1. 免费功能：单聊、群聊、离线消息、音视频通信、消息回执、各类消息格式
1. 免费额度：7天离线消息、每天1000万消息量、每个应用20万群聊、14天聊天历史纪录、5*8小时远程支持
1. 收费标准：每10万日活用户5000元每月

#### 融云

1. [价格详情](http://www.rongcloud.cn/pricing)
1. 免费条件：500万用户以下永久免费
1. 免费功能：除消息云存储、多端同步、直播聊天、音视频通信、私有部署、客服等特殊功能以外的绝大部分功能
1. 免费额度：每天1000万消息量、每月10000分钟免费音视频通信
1. 收费标准：需商务咨询

#### 亲加

1. [价格详情](http://www.gotye.com.cn/IM.html)
1. 免费条件：日活1000以下免费
1. 免费功能：除特殊部署、监控、客服等功能外的绝大部分功能
1. 免费额度：3个月聊天消息、5*8线上支持
1. 收费标准：超过1000日活，0.1元/日活/月

#### 容联

1. [价格详情](http://www.yuntongxun.com/price/price.html)
1. 免费条件：除特殊部署要求外免费
1. 免费功能：绝大部分功能
1. 免费额度：需商务咨询
1. 收费标准：需商务咨询

#### 阿里

1. 免费条件：官方描述是`阿里悟空当前是不收费的，未来会有收费计划，定价将会很有竞争力`，但目前需要邀请才能注册

#### 腾讯

1. [价格详情](https://www.qcloud.com/product/im.html#price)
1. 免费条件：日活10万以下免费
1. 免费功能：绝大部分功能
1. 免费额度：7天消息漫游、100M消息存储每用户、单接口每秒100次调用
1. 收费标准：10000元/月/10万DAU

#### 网易

1. [价格详情](http://netease.im/price)
1. 免费挑件：只提供试用版，100个测试帐号，全部功能
1. 收费标准：需商务咨询

### <span id="security">安全</span>

| | 环信 | 融云 | 亲加 | 容联 | 阿里 | 腾讯 | 网易 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 反垃圾 | √ | √ | 敏感词过滤 | | | 敏感词过滤 | |
| 数据加密 | √ | √ | √ | √ | √ | √ | √ |
| 第三方评估 | √ | √ | | | | | |

**结论**：环信做的最好，其他差不多

### <span id="data">数据统计</span>

| | 环信 | 融云 | 亲加| 容联 | 阿里 | 腾讯 | 网易 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 用户活跃度 | √ | √ | √ |  | | √ | √ |
| 用户行为分析 | √ |  | |  | | | |
| 留存率 | √ | | √ | | | | |
| 群用户和消息统计 | √ | √ | √ |  | | | |
| 自定义指标 | √ | | | | | | |

* 阿里有数据统计功能，但由于无帐号且手册没有具体内容，因此这里都为空

**结论**：环信最好，亲加、融云次之，其余基本只提供个日活数，因为定价一般按日活数来计算

### <span id="protocol">协议与实现</span>

当前流行的IM协议有：

| 协议 | 简介 | 优点 | 缺点 | 典型案例 |
| --- | --- | --- | --- | --- |
| 文本 | 贴近人类语言表达的文本 | 可读性好、便于调试、扩展性好 | 解析效率一般，对二进制如图片视频支持不好 | MSN |
| XMPP | 基于XML的消息协议 | 标准协议广泛使用、跨域互通、扩展性强 | 解析代价高、传输效率低 | gtalk, facebook, weibo |
| MQTT | IBM开发的即时通讯协议 | 多平台 | 简单的消息协议、要自己实现好友、群组等 | 推送  |
| SIP | 基于SIP，增加了message和presence的扩展 | 已有SIP voip服务的基础上支持短信 | SIP信令控制的扩展，比较复杂 | voip、运营商网络 |
| 二进制协议 | 一般为IM服务商私有协议 | 对同步支持好、流量小、解析效率超高 | 工作量大、扩展性差、可读性差、难以调试 | QQ、微信 |

当前流行的IM开源服务器有：

| 服务器 | 语言 | 优点 | 不足 |
| --- | --- | --- | --- |
| Openfire | Java | 成熟稳定、Java程序简单模块化、使用Apache Mina Nio、支持插件且插件较丰富 | 对内存要求高、单机支持用户少、集群支持相对薄弱 |
| Ejabberd | Erlang | 成熟稳定、强大集群支持、热部署、Erlang并发性好 | 语言小众、开发成本高

本文几个IM云采用的是：

| | 环信 | 融云 | 亲加 | 容联 | 阿里 | 腾讯 | 网易 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 协议 | 改进的XMPP协议 | 私有二进制 | 私有二进制 | protobuffer | 不详 | 私有二进制 | 私有二进制 |
| 服务端 | 基于ejabberd | 纯自研 | 不详 | 基于Message Queue | 不详 | 不详 | 不详 |

IM云的总体趋势是使用私有二进制协议保证移动网络的高效通信，服务端则多为自行研究的大型分布式架构，使用mq做内部通信，使用nosql存储聊天等信息。

### <span id="summary">总结</span>

#### 环信

作为几个方案中最老牌的，整体表现也是中规中矩。它的优点在于客户支持、安全性和数据统计方面，也正好匹配它作为最老牌最成熟的地位。但是多项指标都被融云赶超，选择的时候可能会倾向于融云

#### 融云

作为仅次于环信的最老牌方案，各方面指标都针对环信做了提高。它的功能非常全面，而且背景是前飞信团队，整体品质也值得信赖

#### 亲加

整体表现比较一般，但是其在游戏领域有多年经验，目前推的IM方案也是针对游戏内聊天和游戏视频直播的（比如功能中没提到附件，因为在游戏聊天场景是没有附件需求的），有这两块需求的可以优先考虑

#### 容联

特点在于除了IM以外，提供了多种通讯功能：通话服务、短信语音验证码、呼叫中心、流量分发、视频等，算是通讯的一站式解决方案，同时免费力度很大

#### 阿里

阿里的IM云是今年才推出的，因此不管是功能还是文档说明都显得很单薄，可能还是需要等到其比较成熟后再使用

#### 腾讯

腾讯云通信有QQ微信多年的IM经验，且易于和QQ帐号做对接，同时腾讯数据中心分布的广度也能很好的解决在弱网络连接时能及时切换

#### 网易

云信的特点是收费保障稳定，所以算是品质较高的服务，其功能也很全，官方说明文档和接入方案都做的不错

### <span id="advice">个人选型意见</span>

如果倾向于使用专业玩家，融云是第一选择，功能全、免费额度大、市场份额高、足够成熟；如果倾向于使用巨头玩家，腾讯云通信是第一选择，功能全、免费额度较大、腾讯IM的经验业界最强、背靠腾讯云全国布点多网络速率会比较好。

在功能匹配、价格等因素确定好后，最重视的因素应该是稳定性、可用性和7*24客服支持，也就是说在弱网络环境下，各种率是否还能保证，如果出问题是否有客服能及时帮忙解决。这些方案目前宣传的指标都是很高的，但实际效果可能有所差别，需要参考某些大客户的使用经验。

### 附录一用户接入细节

#### 环信

1. 已有注册用户：应用服务器循环调用创建环信用户的REST方法来将用户信息同步到云服务器上
2. 新注册用户：应用客户端创建用户成功后调用创建环信账号的REST方法来创建环信账号
3. 用户登录：应用客户端通过环信用户名密码直接登录

环信由于使用的是基于XMPP的架构，必须要在环信云端也创建用户帐号，造成老帐号需要手动同步，新注册需要应用服务器和环信同时注册，比较麻烦。其好处是用户登录IM时直接用环信的用户名密码即可，不需要在客户端存储任何信息，也不需要去应用服务器拿token

#### 融云

融云提供的即时消息传输服务，不在应用之外建立并行的用户体系，不需要同步用户账户，不影响应用 现有的系统架构与帐号体系（实际还是在云端存储了用户ID，因为需要维护后续的好友、群组等关系）

在用户登录时，应用客户端通过用户ID到应用服务器获得token，然后通过此token到融云服务器登录。token有一定有效期，后续登录可以一直使用，如图所示：

![Alt text](http://img.blog.csdn.net/20151117150127981?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

融云的方案应该是和现有业务体系解耦比较好的，既不存在同步老用户的问题，也不需要在客户端存储key。不过其需要应用服务器的支持，对极少数无后端的应用不适合

#### 亲加

亲加通讯云提供了三种用户集成方式：

1. 自动注册：不需要对用户系统做提前操作，而当客户端集成了以后，首次登陆时会自动创建成为一个新用户
2. 授权注册：需要导入用户信息进行认证。无论是否导入密码，都不会产生自动注册用户
3. 三方认证：无需导入用户，而是将每个登陆的用户发送到开发者自身的认证接口进行认证，亲加不会对用户数据做保存

前两种方案类似于环信的做法，只是第一种方案通过自动化免去了同步老用户。

#### 容联

容联云通讯使用两种用户接入方式：

* 固定子账号体系：开发者需要自己调用创建子账号接口，为应用的用户创建对应的云通讯voip账号，并将voip账号和用户ID进行绑定，voip密码和用户密码进行绑定，登录的时候必须用云通讯voip账号和voip密码登录

![Alt text](http://www.yuntongxun.com/front/images/wiki/img6.jpg)
![Alt text](http://www.yuntongxun.com/front/images/wiki/img7.jpg)

*  任意子账号体系：不必在云通讯后台为用户创建云通讯子账号，可以直接使用用户应用账号进行登录，该登录方式云通讯后台不验证密码。用户在集成的过程中，可以自己实现对登录账号密码的验证。

![Alt text](http://www.yuntongxun.com/front/images/wiki/img8.jpg)

第一种类似环信的做法，第二种类似融云的做法

#### 阿里

>阿里悟空支持免导入登录方式，开发者可以方便的将已有的用户体系与阿里悟空实现对接，而无需将现有用户信息提前导入阿里悟空

>阿里悟空使用 OpenID（long 型）来唯一标识一个用户。在联合鉴权机制下，OpenID 的分配及维护由开发者自行维护，需要保证其确定且唯一（通常，开发者将应用原本的 userID 进行简单的映射或者直接使用 userID 作为传递给悟空的 OpenId 即可）

具体步骤为：
![Alt text](https://img.alicdn.com/tps/TB1HzzdJpXXXXaRXpXXXXXXXXXX-724-363.png)

阿里的做法与融云类似

#### 腾讯

腾讯云通信的用户集成支持独立模式和托管模式：

* 独立模式：用户帐号信息由开发者保存，用户身份验证（比如注册与验密）也由开发者负责，开发者在申请接入时，可以直接下载公私钥用于开发，或者按照要求生成公私钥，将公钥提交腾讯服务器，而后用私钥加密指定数据生成签名交由腾讯服务器验证合法性。用户在APP客户端输入帐号密码后到APP自有帐号登录服务器验证，验证成功后，APP自有帐号登录服务器使用私钥派发签名（UserSig）给客户端
![Alt text](https://avc.qcloud.com/wiki2.0/im/imgs/20151116095534_82173.png)
![Alt text](https://avc.qcloud.com/wiki2.0/im/imgs/20151116095011_75847.png)
* 托管模式：由腾讯为开发者提供帐号的密码注册、存储和密码验证，以及第三方openid和token的托管验证服务。
![Alt text](https://avc.qcloud.com/wiki2.0/im/imgs/20151116095740_64728.png)
![Alt text](https://avc.qcloud.com/wiki2.0/im/imgs/20151116095831_86603.png)
其中TLS是腾讯的登录服务（Tencent Login Service），为开发者快速完成帐号集成接入云通讯服务而提供的一套通用帐号登录组件。实现包括QQ、微信、新浪微博、人人在内的多种帐号类型登录使用音视频通讯和即时通讯。开发者可以通过简单的SDK集成，便捷的接口调用，即可实现原本复杂的登录验证服务，使代码量急剧减少

两种模式下对于已注册的老用户，均需要将用户导入。

#### 网易

网易云信的用户字段包括accid（云信用户ID）、token（云信用户口令）、name（推送昵称），用户集成具体流程是：
![Alt text](http://dev.netease.im/images/upload/manage_nimuser.png)

整体类似融云的做法，但是对于老注册用户，需要应用服务器端导入一次
